---
name: heal-skill
description: スキルに間違った指示や古いAPI参照がある場合に、不正なSKILL.mdファイルを修正する
argument-hint: [オプション: 修正する具体的な問題]
allowed-tools: [Read, Edit, Bash(ls:*), Bash(git:*)]
---

<objective>
実行中に発見された修正に基づいて、スキルのSKILL.mdと関連ファイルを更新します。

会話を分析して実行中のスキルを検出し、何が間違っていたかを振り返り、具体的な修正を提案し、ユーザーの承認を得て、オプションのコミットと共に変更を適用します。
</objective>

<context>
スキル検出: !`ls -1 ./skills/*/SKILL.md | head -5`
</context>

<quick_start>
<workflow>
1. 会話コンテキストからスキルを**検出**（呼び出しメッセージ、最近のSKILL.md参照）
2. 何が間違っていたか、どのように修正を発見したかを**振り返る**
3. 前後の差分と共に提案された変更を**提示**
4. 編集を行う前に**承認を得る**
5. 変更を**適用**し、オプションでコミット
</workflow>
</quick_start>

<process>
<step_1 name="detect_skill">
会話コンテキストからスキルを特定：

- スキル呼び出しメッセージを探す
- 最近参照されたSKILL.mdをチェック
- 現在のタスクコンテキストを調べる

設定：`SKILL_NAME=[skill-name]` および `SKILL_DIR=./skills/$SKILL_NAME`

不明確な場合はユーザーに質問。
</step_1>

<step_2 name="reflection_and_analysis">
$ARGUMENTSが提供されている場合はそれに焦点を当て、そうでなければより広いコンテキストを分析。

判断項目：
- **何が間違っていたか**：SKILL.mdから不正なセクションを具体的に引用
- **発見方法**：Context7、エラーメッセージ、試行錯誤、ドキュメント検索
- **根本原因**：古いAPI、不正なパラメータ、間違ったエンドポイント、欠落しているコンテキスト
- **影響範囲**：単一セクションか複数か？関連ファイルも影響を受けるか？
- **提案される修正**：どのファイル、どのセクション、各々の前後
</step_2>

<step_3 name="scan_affected_files">
```bash
ls -la $SKILL_DIR/
ls -la $SKILL_DIR/references/ 2>/dev/null
ls -la $SKILL_DIR/scripts/ 2>/dev/null
```
</step_3>

<step_4 name="present_proposed_changes">
以下のフォーマットで変更を提示：

```
**修復対象スキル:** [skill-name]
**発見された問題:** [1-2文の要約]
**根本原因:** [簡潔な説明]

**変更されるファイル:**
- [ ] SKILL.md
- [ ] references/[file].md
- [ ] scripts/[file].py

**提案される変更:**

### 変更1: SKILL.md - [セクション名]
**場所:** SKILL.mdの[X]行目

**現在（不正）:**
```
[現在のファイルからの正確なテキスト]
```

**修正後:**
```
[新しいテキスト]
```

**理由:** [これが問題を修正する理由]

[すべてのファイルにわたる各変更について繰り返す]

**影響評価:**
- 影響を受ける: [認証/APIエンドポイント/パラメータ/例/など]

**検証:**
これらの変更により防止される: [この変更のきっかけとなった具体的なエラー]
```
</step_4>

<step_5 name="request_approval">
```
これらの変更を適用しますか？

1. はい、すべての変更を適用してコミット
2. 適用するがコミットしない（先にレビューさせて）
3. 変更を修正（フィードバックを提供します）
4. キャンセル（変更しない）

選択 (1-4):
```

**ユーザーの応答を待つ。承認なしに進めない。**
</step_5>

<step_6 name="apply_changes">
承認後（オプション1または2）のみ：

1. すべてのファイルにわたる各修正にEditツールを使用
2. 変更された箇所を読み返して検証
3. オプション1の場合、何が修復されたかを示す構造化されたメッセージでコミット
4. ファイルリストで完了を確認
</step_6>
</process>

<success_criteria>
- 会話コンテキストからスキルが正しく検出された
- すべての不正なセクションが前後と共に特定された
- ユーザーが適用前に変更を承認した
- SKILL.mdと関連ファイルにわたってすべての編集が適用された
- 読み返しで変更が検証された
- ユーザーがオプション1を選択した場合はコミットが作成された
- ファイルリストで完了が確認された
</success_criteria>

<verification>
完了前に：

- 各変更されたセクションを読み返して変更が適用されたことを確認
- ファイル間の整合性を確保（SKILL.mdの例がreferences/と一致）
- オプション1が選択された場合はgitコミットが作成されたことを検証
- 意図しないファイルが変更されていないことをチェック
</verification>
