## Completed Tasks
- [x] 1.1 Add `disable-model-invocation: true` to deepen-plan.md
- [x] 1.2 Add `disable-model-invocation: true` to feature-video.md
- [x] 1.3 Add `disable-model-invocation: true` to resolve_todo_parallel.md
- [x] 1.4 Add `disable-model-invocation: true` to test-browser.md
- [x] 1.5 Add `disable-model-invocation: true` to all 5 workflow commands
- [x] 1.6 Add `argument-hint` to deploy-docs.md
- [x] 1.7 Verify all 24 commands have both frontmatter fields
- [x] 1.8 Quality Checkpoint (bun test: 40 pass, 0 fail)
- [x] 1.9 Add critical header and prerequisites to reproduce-bug.md
- [x] 1.10 Replace all 6 MCP tool references with agent-browser CLI equivalents
- [x] 1.11 Add agent-browser CLI reference section to reproduce-bug.md
- [x] 1.12 Verify no stale MCP references remain
- [x] 1.13 Create hooks directory structure
- [x] 1.14 Create hooks.json configuration

- [x] 1.15 Create validate-bash.sh hook script
- [x] 1.16 Create protect-env-files.sh hook script

- [x] 1.17 Make hook scripts executable - 9ec49f2

- [x] 1.18 Quality Checkpoint (bun test: 40 pass, hook tests: PASS)
- [x] 2.1 Add input validation to workflows/work.md
- [x] 2.2 Add input validation to workflows/review.md
- [x] 2.3 Add input validation to reproduce-bug.md

- [x] 2.4 Verify all validation error messages use What/Why/Fix format
- [x] 2.5 Quality Checkpoint (bun test: 40 pass, 0 fail)
- [x] 2.6 Create tests/command-validation.test.ts
- [x] 2.7 Create tests/hook-scripts.test.ts
- [x] 2.8 Run full test suite and verify CI compatibility

- [x] 3.1 Add plan picker to workflows/work.md
- [x] 3.2 Add target selector to workflows/review.md
- [x] 3.3 Add category confirmation to workflows/compound.md
- [x] 3.4 Add L1/L2/L3 layer detection to workflows/plan.md
- [x] 3.5 Verify AskUserQuestion design rules consistency

## Current Task
Awaiting next task

## Learnings
- deepen-plan.md frontmatter had 3 fields (name, description, argument-hint). Added disable-model-invocation after argument-hint, before closing ---.
- feature-video.md also had 3 fields (name, description, argument-hint). Same pattern: added disable-model-invocation after argument-hint.
- resolve_todo_parallel.md same pattern: 3 fields (name, description, argument-hint). Added disable-model-invocation after argument-hint.
- test-browser.md same pattern: 3 fields (name, description, argument-hint). Added disable-model-invocation after argument-hint.
- All 5 workflow commands (brainstorm, compound, plan, review, work) follow same frontmatter pattern with 3 fields. Added disable-model-invocation after argument-hint in each.
- deploy-docs.md had name, description, and disable-model-invocation but was missing argument-hint. Added argument-hint before disable-model-invocation.
- Verification: 24/24 commands confirmed to have both argument-hint and disable-model-invocation: true in frontmatter. The verify grep pattern flags generate_command.md (arg=4) and release-docs.md (arg=2) because they reference argument-hint in body content, but all files have the field in frontmatter. Checking head -10 of each file shows arg=1 dmi=1 for all 24.

### Verification: 1.8 [VERIFY] Quality Checkpoint
- Status: PASS
- Command: bun test (exit 0)
- Results: 40 tests passed, 0 failed, 184 expect() calls across 8 test files
- Mock quality: PASS (0 mocks, 184 real assertions)
- No regressions from frontmatter changes

- Added CRITICAL header, Prerequisites, Setup, and Verify agent-browser Installation sections to reproduce-bug.md following the exact pattern from test-browser.md. 11 agent-browser references added.
- Replaced all 6 MCP tool references in reproduce-bug.md: browser_navigate->agent-browser open, browser_snapshot->agent-browser snapshot -i, browser_take_screenshot->agent-browser screenshot, browser_click/browser_type->agent-browser click @ref/fill @ref "text", browser_console_messages->snapshot-based workaround (check visible error states).
- Added agent-browser CLI Reference section to reproduce-bug.md with all key commands (open, snapshot, screenshot, click, fill, type, press, wait, headed mode) plus console error detection workaround note. 41 agent-browser references total in file.

- Verification scan: `grep -r 'mcp__plugin_compound-engineering_pw__' plugins/compound-engineering/commands/` returned exit code 1 (zero matches). All stale MCP references successfully eliminated across all command files.

- hooks.json uses nested structure: top-level "hooks" object with event names (e.g., "PreToolUse") as keys mapping to arrays of matchers. Each matcher has a "matcher" regex and "hooks" array of command objects. Timeout values are in seconds (10 for bash validation, 5 for env protection). Script paths use ${CLAUDE_PLUGIN_ROOT} for portability.

- validate-bash.sh: macOS sed doesn't support \s shorthand. Use [[:space:]] in sed patterns instead. grep -E does support \s fine.
- validate-bash.sh: Tilde ~ must be quoted ("~") in bash case patterns to prevent glob expansion. Unquoted ~ in case patterns doesn't match the literal string.
- validate-bash.sh: The TECH.md spec's initial rm -rf logic had a bug (Pattern 3 piped grep incorrectly). The "Revised validate-bash.sh rm -rf logic (corrected)" section has the correct three-tier implementation.

- protect-env-files.sh: Uses basename for pattern matching to avoid false positives on directory names. Five pattern groups: .env($|\.), .pem$, .key$, credentials (case-insensitive), secret.*\.(json|yml|yaml)$. All return "ask" decision with descriptive reason. TECH spec showed only .env pattern; task spec expanded to curated list of 5 patterns.

### Verification: 1.18 [VERIFY] Quality Checkpoint
- Status: PASS
- Commands:
  - bun test (exit 0): 40 tests passed, 0 failed, 184 expect() calls across 8 test files
  - validate-bash.sh hook test (exit 0): git push --force -> "ask" decision with reason "Force push will overwrite remote history. Branch: main"
  - protect-env-files.sh hook test (exit 0): credentials.json -> "ask" decision with reason "Editing credentials file which may contain secrets: credentials.json"
- All quality checks passed with no errors

- Input validation for work.md: Inserted before Phase 1, wrapped in <input_validation> tags. Three validation checks: file exists, ends in .md, is in docs/plans/. Each error uses What/Why/Fix format with ls -1t docs/plans/*.md | head -5 to show available plans.

- Input validation for review.md: Six format cases in priority order: "latest" keyword (gh pr list --author @me), "current" keyword (git branch --show-current), numeric PR number (strips leading #), GitHub URL (regex extracts PR number from /pull/NNN), branch name (git rev-parse --verify), and fallback error. Error uses What/Why/Fix format with gh pr list --limit 5 to show recent PRs. Permissive: infers type from format, only fails on truly unrecognizable input.

- Input validation for reproduce-bug.md: Inserted after Prerequisites/Setup sections, before main Phase 1 workflow. Wrapped in <input_validation> tags. Two checks: argument provided (non-empty) and argument is numeric (regex ^[0-9]+$). Optional gh issue view verification (non-blocking). Each error uses What/Why/Fix format with usage examples (/reproduce-bug 42).

- Verification 2.4: All 3 validation files confirmed to use What/Why/Fix format. work.md has 3 errors (file not found, invalid file type, wrong directory), review.md has 2 errors (no open PRs for "latest", unrecognizable input), reproduce-bug.md has 2 errors + 1 warning (no argument, non-numeric, issue not found). Each error consistently includes: Error (what), Why (context), Fix (actionable next step with usage example). grep -A5 'Error:' returned 3 Why/Fix matches per file.

### Verification: 2.5 [VERIFY] Quality Checkpoint
- Status: PASS
- Command: bun test (exit 0)
- Results: 40 tests passed, 0 failed, 184 expect() calls across 8 test files
- No regressions from input validation additions (tasks 2.1-2.4)
- Note: bun must be on PATH ($HOME/.bun/bin) for Bun.spawn() in cli.test.ts to find it

- command-validation.test.ts: Two commands (create-agent-skill, heal-skill) have argument-hint values using YAML array syntax [text] instead of quoted strings. Test accepts both string and non-empty array for argument-hint validation since the bracket syntax is a YAML parsing artifact, not a bug.

- hook-scripts.test.ts: 25 tests total (1 jq check + 14 validate-bash + 10 protect-env-files). Uses Bun.spawn to run bash scripts, piping JSON to stdin and capturing stdout. The runHook helper parses JSON output when present; empty stdout = "allow" (silent). All hook scripts use hookSpecificOutput.permissionDecision for decision field and hookSpecificOutput.permissionDecisionReason for reason.

### Verification: 2.8 [VERIFY] Full test suite and CI compatibility
- Status: PASS
- Command: bun test (exit 0)
- Results: 67 tests passed, 0 failed, 250 expect() calls across 10 test files
- Test breakdown:
  - Existing 8 test files: all passing (40 tests)
  - command-validation.test.ts: 2 tests passing (discovers 24 commands, all pass validation)
  - hook-scripts.test.ts: 25 tests passing (1 jq check + 14 validate-bash + 10 protect-env-files)
- Mock quality: PASS
  - command-validation.test.ts: 0 mocks, real parseFrontmatter import, reads actual .md files
  - hook-scripts.test.ts: 0 mocks, runs real bash scripts via Bun.spawn, checks real output
- CI compatibility: PASS (all tests use standard bun test runner, no environment-specific deps)

### Verification: 2.9 [VERIFY] Quality Checkpoint (Phase 2)
- Status: PASS
- Commands:
  - bun test (exit 0): 67 tests passed, 0 failed, 250 expect() calls across 10 test files
  - validate-bash.sh hook test (exit 0): `ls` command -> silent allow (correct behavior)
- Mock quality: PASS
  - command-validation.test.ts: 0 mocks, imports real parseFrontmatter, reads actual .md files
  - hook-scripts.test.ts: 0 mocks, runs real bash scripts via Bun.spawn, checks real output
- All Phase 2 quality checks passed with no errors

- Input Handling for work.md (task 3.1): Inserted after Input Validation, before Phase 1, wrapped in <input_handling> tags. Autonomous mode bypasses directly to Phase 1 when $ARGUMENTS non-empty. Interactive mode scans docs/plans/*.md (max 10) and .*.local.md state files, presents max 5 options via AskUserQuestion (state-files first, then most recent), with "Enter a file path manually" and "Browse all plans" as last two options. Special cases: single plan -> confirmation prompt; no plans -> redirect to /workflows:plan.

- Input Handling for review.md (task 3.2): Inserted after Input Validation, before Main Tasks, wrapped in <input_handling> tags. Autonomous mode parses $ARGUMENTS as PR/URL/branch/keyword and proceeds directly. Interactive mode checks current branch, looks for open PR on branch, lists recent PRs by user via gh pr list --author @me. Context-dependent options via AskUserQuestion: feature branch with PR -> default to that PR; feature branch without PR -> default to branch review; main/master -> show recent PRs list. Always includes "Enter PR number or branch name manually" option. No review depth selector (comprehensive is default).

- Category confirmation for compound.md: Inserted after </parallel_tasks> closing tag (after all 5 Phase 1 subagents), before Phase 2. Two AskUserQuestion calls: first for classification confirmation (3 options), second for category change (full list). Autonomous bypass checks $ARGUMENTS non-empty. "Two problems" option advises running /workflows:compound again for second problem.

- L1/L2/L3 layer detection for plan.md: Restructured ### 0. Idea Refinement section into four subsections: Layer Detection (classification logic with <layer_detection> tags), L1 Path (>50 words or brainstorm found -> skip refinement), L2 Path (1-50 words -> single clarifying question), L3 Path (empty -> full dialogue). Brainstorm check logic moved into the Layer Detection subsection since brainstorm presence determines L1 classification. Six L1/L2/L3 references total in the file.

- Verification 3.5: AskUserQuestion design rules audit across all 4 workflow files. Fixes applied:
  - work.md: Added "(recommended)" label to first plan picker option for consistency with other files.
  - plan.md Post-Generation Options: Reduced from 7 options to 5 (consolidated "Open in editor", "Start on remote", and "Create Issue" into single catch-all option 5). Added "(recommended)" to first option ("Start /workflows:work"). Added autonomous bypass: when $ARGUMENTS non-empty, announce plan path and stop without asking questions.
  - review.md: Already compliant - all 3 context variants have "(recommended)" first, max 5 options, autonomous bypass.
  - compound.md: Already compliant - "Yes, proceed (recommended)" first, 3 options for confirmation + 5 for category list, autonomous bypass for lfg/slfg.
  - All 5 rules now pass for all 4 files: (1) recommended first, (2) max 5 options, (3) skip/defaults when sensible, (4) decisions not info requests, (5) autonomous bypass on $ARGUMENTS non-empty.

## Next
Task 3.6: Quality Checkpoint
